importScripts("base.js");
golf.ammo={};golf.ammo.vec3=function(a,b,c,d){return new a.btVector3(b,c,d)};golf.ammo.quat=function(a,b,c,d,e){return new a.btQuaternion(b,c,d,e)};golf.ammo.world=function(a){var b=new a.btDefaultCollisionConfiguration,c=new a.btCollisionDispatcher(b),d=new a.btDbvtBroadphase,e=new a.btSequentialImpulseConstraintSolver;b=new a.btDiscreteDynamicsWorld(c,d,e,b);b.setGravity(golf.ammo.vec3(a,0,-9.8,0));return b};golf.ammo.transform=function(a){return new a.btTransform};
golf.ammo.box_shape=function(a,b,c,d){return new a.btBoxShape(golf.ammo.vec3(a,b,c,d))};golf.ammo.sphere_shape=function(a,b){return new a.btSphereShape(b)};golf.ammo.rigid_body=function(a,b,c,d,e,f,g){var h=golf.ammo.vec3(a,0,0,0);c=new a.btDefaultMotionState(c);cljs.core.not_EQ_.cljs$core$IFn$_invoke$arity$2(0,d)&&b.calculateLocalInertia(d,h);b=new a.btRigidBodyConstructionInfo(d,c,b,h);b.set_m_friction(e);b.set_m_rollingFriction(f);b.set_m_restitution(g);return new a.btRigidBody(b)};
golf.ammo.create_shape=function(a,b){var c=b.shape;switch(c){case "box":var d=b.size;b=cljs.core.nth.cljs$core$IFn$_invoke$arity$3(d,0,null);c=cljs.core.nth.cljs$core$IFn$_invoke$arity$3(d,1,null);d=cljs.core.nth.cljs$core$IFn$_invoke$arity$3(d,2,null);return golf.ammo.box_shape(a,b,c,d);case "sphere":return golf.ammo.sphere_shape(a,b.radius);default:throw Error(["No matching clause: ",cljs.core.str.cljs$core$IFn$_invoke$arity$1(c)].join(""));}};
golf.ammo.create_rigid_body=function(a,b,c,d){var e=cljs.core.nth.cljs$core$IFn$_invoke$arity$3(c,0,null),f=cljs.core.nth.cljs$core$IFn$_invoke$arity$3(c,1,null);c=cljs.core.nth.cljs$core$IFn$_invoke$arity$3(c,2,null);var g=cljs.core.nth.cljs$core$IFn$_invoke$arity$3(d,0,null),h=cljs.core.nth.cljs$core$IFn$_invoke$arity$3(d,1,null),k=cljs.core.nth.cljs$core$IFn$_invoke$arity$3(d,2,null);d=cljs.core.nth.cljs$core$IFn$_invoke$arity$3(d,3,null);var l=golf.ammo.create_shape(a,b),m=golf.ammo.transform(a);
m.setOrigin(golf.ammo.vec3(a,e,f,c));m.setRotation(golf.ammo.quat(a,g,h,k,d));return golf.ammo.rigid_body(a,l,m,b.mass,function(){var a=b.friction;return cljs.core.truth_(a)?a:.5}(),function(){var a=b.rollingFriction;return cljs.core.truth_(a)?a:0}(),function(){var a=b.restitution;return cljs.core.truth_(a)?a:0}())};
golf.ammo.ground=function(a){var b=golf.ammo.box_shape(a,50,.001,50),c=golf.ammo.transform(a);c.setIdentity();c.setOrigin(golf.ammo.vec3(a,0,0,0));return golf.ammo.rigid_body(a,b,c,0,.5,0,0)};golf.ammo.write_pose=function(a,b,c,d,e){a=c.getMotionState();return cljs.core.truth_(a)?(a.getWorldTransform(b),a=b.getOrigin(),b=b.getRotation(),e[d]=a.x(),e[d+1]=a.y(),e[d+2]=a.z(),e[d+3]=b.x(),e[d+4]=b.y(),e[d+5]=b.z(),e[d+6]=b.w()):null};golf.worker={};if("undefined"===typeof golf||"undefined"===typeof golf.worker||"undefined"===typeof golf.worker.max_instances)golf.worker.max_instances=4E3;if("undefined"===typeof golf||"undefined"===typeof golf.worker||"undefined"===typeof golf.worker._STAR_ammo_STAR_)golf.worker._STAR_ammo_STAR_=null;if("undefined"===typeof golf||"undefined"===typeof golf.worker||"undefined"===typeof golf.worker._STAR_world_STAR_)golf.worker._STAR_world_STAR_=null;
if("undefined"===typeof golf||"undefined"===typeof golf.worker||"undefined"===typeof golf.worker._STAR_bodies_STAR_)golf.worker._STAR_bodies_STAR_=[];if("undefined"===typeof golf||"undefined"===typeof golf.worker||"undefined"===typeof golf.worker._STAR_xform_STAR_)golf.worker._STAR_xform_STAR_=null;if("undefined"===typeof golf||"undefined"===typeof golf.worker||"undefined"===typeof golf.worker.buffer)golf.worker.buffer=new Float32Array(7*golf.worker.max_instances);
if("undefined"===typeof golf||"undefined"===typeof golf.worker||"undefined"===typeof golf.worker.fixed_time_step)golf.worker.fixed_time_step=1/60;self.importScripts("./ammo.js");golf.worker.post_message=function(a,b){return self.postMessage(cljs.core.clj__GT_js(new cljs.core.PersistentArrayMap(null,2,[cljs$cst$keyword$type,a,cljs$cst$keyword$data,b],null)))};golf.worker.log=function(a){return golf.worker.post_message("log",a)};golf.worker.log_js=function(a){return self.postMessage({type:"log",data:a})};
golf.worker.simulate_step=function(){var a=golf.worker._STAR_ammo_STAR_;golf.worker._STAR_world_STAR_.stepSimulation(golf.worker.fixed_time_step,2);for(var b=cljs.core.seq(cljs.core.range.cljs$core$IFn$_invoke$arity$1(cljs.core.count(golf.worker._STAR_bodies_STAR_))),c=null,d=0,e=0;;)if(e<d){var f=c.cljs$core$IIndexed$_nth$arity$2(null,e),g=golf.worker._STAR_bodies_STAR_[f];cljs.core.truth_(g)&&golf.ammo.write_pose(a,golf.worker._STAR_xform_STAR_,g,7*f,golf.worker.buffer);e+=1}else if(b=cljs.core.seq(b))cljs.core.chunked_seq_QMARK_(b)?
(d=cljs.core.chunk_first(b),b=cljs.core.chunk_rest(b),c=d,d=cljs.core.count(d)):(c=cljs.core.first(b),d=golf.worker._STAR_bodies_STAR_[c],cljs.core.truth_(d)&&golf.ammo.write_pose(a,golf.worker._STAR_xform_STAR_,d,7*c,golf.worker.buffer),b=cljs.core.next(b),c=null,d=0),e=0;else break;return self.postMessage({type:"tick",data:golf.worker.buffer})};golf.worker.on_add_body=function(a,b,c){c=c.data;a=golf.ammo.create_rigid_body(a,c.body,c.pos,c.rot);b.addRigidBody(a);return golf.worker._STAR_bodies_STAR_.push(a)};
golf.worker.on_remove_body=function(a,b,c){a=c.idx;b.removeRigidBody(golf.worker._STAR_bodies_STAR_[a]);return golf.worker._STAR_bodies_STAR_[a]=null};golf.worker.start_simulation=function(){var a=golf.worker._STAR_ammo_STAR_,b=golf.ammo.world(a),c=golf.ammo.ground(a);b.addRigidBody(c);golf.worker._STAR_world_STAR_=b;golf.worker._STAR_xform_STAR_=golf.ammo.transform(a);golf.worker._STAR_bodies_STAR_=[];return self.setInterval(golf.worker.simulate_step,1E3/60)};
golf.worker.on_message=function(a){var b=a.data.type;switch(b){case "add-body":return golf.worker.on_add_body(golf.worker._STAR_ammo_STAR_,golf.worker._STAR_world_STAR_,a.data);case "remove-body":return golf.worker.on_remove_body(golf.worker._STAR_ammo_STAR_,golf.worker._STAR_world_STAR_,a.data);case "reset":return golf.worker.start_simulation();default:throw Error(["No matching clause: ",cljs.core.str.cljs$core$IFn$_invoke$arity$1(b)].join(""));}};
self.Ammo().then(function(){var a=self.Ammo;self.addEventListener("message",golf.worker.on_message);golf.worker._STAR_ammo_STAR_=a;golf.worker.log("starting sim...");golf.worker.start_simulation();return golf.worker.post_message("ready",null)});shadow.cljs.bootstrap.env.set_loaded(["golf.ammo","shadow.module.ammo-worker.append","golf.worker"]);